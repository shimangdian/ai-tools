version: '3.8'

services:
  # Message Sender Service
  message-sender:
    build: ./message-sender
    container_name: message-sender
    ports:
      - "8000:8000"
    environment:
      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      # Uncomment and set your API key for authentication
      # - API_KEY=your_secret_api_key_here

      # WeCom Configuration
      - WECOM_ENABLED=true
      - WECOM_WEBHOOK_URL=${WECOM_WEBHOOK_URL}
      # - WECOM_MENTIONED_LIST=user1,user2
      # - WECOM_MENTIONED_MOBILE_LIST=13800138000,13900139000

      # DingTalk Configuration (uncomment to enable)
      # - DINGTALK_ENABLED=true
      # - DINGTALK_WEBHOOK_URL=${DINGTALK_WEBHOOK_URL}
      # - DINGTALK_SECRET=${DINGTALK_SECRET}
      # - DINGTALK_AT_MOBILES=13800138000,13900139000
      # - DINGTALK_AT_ALL=false

      # Feishu Configuration (uncomment to enable)
      # - FEISHU_ENABLED=true
      # - FEISHU_WEBHOOK_URL=${FEISHU_WEBHOOK_URL}
      # - FEISHU_SECRET=${FEISHU_SECRET}
    volumes:
      # Mount config file (optional, environment variables take precedence)
      - ./message-sender/config.yaml:/app/config.yaml
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - ai-tools-network

  # Daily News Service
  daily-news:
    build: ./daily-news
    container_name: daily-news
    environment:
      # News API Configuration
      - NEWS_API_URL=https://dwz.2xb.cn/zaob

      # Message Sender Service Configuration
      - MESSAGE_SENDER_URL=http://message-sender:8000
      # - MESSAGE_SENDER_API_KEY=${MESSAGE_SENDER_API_KEY}

      # OCR Configuration
      - USE_OCR=true
      - MAX_IMAGE_SIDE=8000

      # Schedule Configuration
      - SCHEDULE_ENABLED=true
      - SCHEDULE_HOUR=8
      - SCHEDULE_MINUTE=0
      - SCHEDULE_TIMEZONE=Asia/Shanghai
    volumes:
      # Mount config file (optional)
      - ./daily-news/config.yaml:/app/config.yaml
      # Mount logs directory
      - ./daily-news/logs:/app/logs
    restart: unless-stopped
    depends_on:
      message-sender:
        condition: service_healthy
    networks:
      - ai-tools-network

networks:
  ai-tools-network:
    driver: bridge
