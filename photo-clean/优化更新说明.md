# Photo Clean 优化更新说明

## 本次优化内容

### 1. ✅ 图片展示问题修复

**问题：** 前端无法显示图片，因为使用了 `file://` 协议

**解决方案：**
- 新增后端图片预览 API: [backend/app/api/images.py:18](backend/app/api/images.py#L18)
- 前端通过 HTTP 请求获取图片: [frontend/src/components/ImageCard.vue:40](frontend/src/components/ImageCard.vue#L40)
- 支持所有常见图片格式（JPG、PNG、BMP、GIF、WebP）

### 2. ✅ 全选功能修复

**问题：** 点击"全选"按钮时，图片没有被选中

**解决方案：**
- 重写了 `selectAllInGroup` 函数逻辑: [frontend/src/views/ResultPage.vue:128](frontend/src/views/ResultPage.vue#L128)
- 使用数组操作确保状态正确更新
- 强制触发 Vue 响应式更新

### 3. ✅ 相似度阈值优化

**问题：** 相似度阈值在移动端不够友好

**解决方案：**
- 添加数字输入框，可直接输入数值: [frontend/src/views/ScanPage.vue:42](frontend/src/views/ScanPage.vue#L42)
- 添加移动端响应式样式: [frontend/src/views/ScanPage.vue:268](frontend/src/views/ScanPage.vue#L268)
- 优化提示文字，说明推荐值

**相似度阈值说明：**
- **0-5**: 几乎完全相同
- **6-10**: 高度相似（推荐）
- **11-15**: 中等相似
- **16-20**: 低相似度

### 4. ✅ 扫描目录自动配置

**问题：** 每次扫描都需要手动输入目录路径

**解决方案：**
- 后端支持不传 `scan_dir` 参数，自动使用配置的默认目录: [backend/app/api/scan.py:42](backend/app/api/scan.py#L42)
- 前端提供两种扫描模式: [frontend/src/views/ScanPage.vue:22](frontend/src/views/ScanPage.vue#L22)
  - **默认模式**: 扫描全部照片目录（推荐）
  - **自定义模式**: 扫描指定子目录

## 技术改进

### 后端 API 增强

1. **新增图片预览接口**
   ```python
   GET /api/images/preview?file_path={path}
   ```
   - 返回图片文件流
   - 自动设置正确的 Content-Type
   - 支持所有常见图片格式

2. **扫描接口优化**
   - `scan_dir` 参数变为可选
   - 未指定时自动使用环境变量 `PHOTO_DIR`

### 前端体验优化

1. **图片展示**
   - 使用 HTTP API 获取图片
   - 支持跨域访问
   - 生产环境通过 Nginx 代理

2. **移动端适配**
   - 相似度阈值控件响应式设计
   - 优化触摸操作体验
   - 自适应屏幕尺寸

3. **环境变量配置**
   - 开发环境: `VITE_API_URL=http://localhost:8000`
   - 生产环境: 使用相对路径，通过 Nginx 代理

## 配置文件说明

### 新增文件

1. **frontend/.env**
   ```bash
   VITE_API_URL=http://localhost:8000
   ```
   开发环境配置

2. **frontend/.env.production**
   ```bash
   VITE_API_URL=
   ```
   生产环境配置（留空使用相对路径）

### 修改的文件

1. **backend/app/api/images.py** - 新增预览接口
2. **backend/app/api/scan.py** - 优化扫描接口
3. **backend/app/models/schemas.py** - scan_dir 改为可选
4. **frontend/src/components/ImageCard.vue** - 使用 API 获取图片
5. **frontend/src/views/ScanPage.vue** - 优化扫描配置界面
6. **frontend/src/views/ResultPage.vue** - 修复全选功能

## 使用方式

### 启动项目

```bash
# 使用一键启动脚本
./start.sh  # Linux/macOS
# 或
start.bat   # Windows
```

### 扫描照片

1. 访问 http://localhost:8080
2. 点击"开始扫描"
3. 选择扫描模式：
   - **扫描全部照片目录**（推荐）- 自动扫描配置的 `./photos` 目录
   - **扫描指定子目录** - 可指定子目录路径
4. 调整相似度阈值（推荐值：10）
5. 点击"开始扫描"按钮

### 处理结果

1. 扫描完成后查看相似图片组
2. 使用功能按钮：
   - **全选** - 选中组内所有图片
   - **取消全选** - 取消选中
   - **保留最佳** - 自动选中除最佳图片外的所有图片
3. 点击"删除选中"批量删除

## 数据流程

```
前端请求 → Nginx 代理 → 后端 API
    ↓
获取图片预览
    ↓
/api/images/preview?file_path=/data/photo/xxx.jpg
    ↓
后端读取文件并返回
    ↓
前端展示图片
```

## 注意事项

1. **图片路径**: 数据库中存储的是容器内路径 `/data/photo/xxx.jpg`
2. **API 访问**: 生产环境通过 Nginx 反向代理访问后端
3. **相似度阈值**: 该值会影响扫描结果，建议从 10 开始调整
4. **全选功能**: 现在可以正确选中/取消选中所有图片

## 测试建议

1. 测试图片展示是否正常
2. 测试全选/取消全选功能
3. 测试不同相似度阈值的扫描结果
4. 测试移动端界面是否友好
5. 测试默认扫描模式是否正常工作

## 后续优化建议

1. 添加图片懒加载，提升大量图片时的性能
2. 添加图片放大预览功能
3. 支持图片拖拽排序
4. 添加批量导出功能
5. 优化扫描算法性能

---

**更新时间**: 2025-12-05
**版本**: v1.1.0
