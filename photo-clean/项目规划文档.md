# 群晖 NAS 相似图片清理软件 - 项目规划文档

## 一、可行性分析

### 1.1 技术可行性：高

**支持条件：**
- ✅ 群晖平台支持：群晖 DSM 支持多种应用部署方式（Docker、原生套件）
- ✅ 图片处理成熟：有成熟的图片相似度算法和库
- ✅ NAS 环境适配：可以直接访问文件系统，适合批量处理

### 1.2 核心技术挑战

1. **图片相似度算法性能优化**：大量图片对比时的计算效率
2. **NAS 硬件资源限制**：需要考虑 CPU、内存的合理使用
3. **用户友好的交互界面**：提供直观的图片对比和操作界面

---

## 二、技术栈选型

### 2.1 推荐方案：Docker + Python + Web UI

#### 后端技术栈
- **Python 3.10+**：图片处理生态成熟，库丰富
- **FastAPI**：轻量级高性能 Web 框架，自动生成 API 文档
- **imagehash**：感知哈希算法库（支持 pHash、aHash、dHash）
- **Pillow**：Python 图片处理标准库
- **SQLite**：轻量级数据库，存储图片哈希和元数据

#### 前端技术栈
- **Vue 3 + Vite**：轻量级现代前端框架，开发体验好
- **Element Plus**：企业级 UI 组件库
- **图片对比查看器**：支持并排对比、缩放等功能

#### 部署方案
- **Docker Compose**：一键部署，环境隔离
- **支持群晖 Docker 套件**：直接在群晖 UI 中管理

#### 方案优势
- ✅ 跨平台，不依赖群晖 SDK，可移植性强
- ✅ 开发效率高，使用成熟技术栈
- ✅ 易于维护和升级
- ✅ 可以在任何 NAS 或服务器上运行

### 2.2 备选方案：群晖原生套件

**不推荐原因：**
- 需要学习群晖 SPK 打包规范
- 开发周期较长
- 仅适用于群晖平台
- 除非计划上架群晖套件中心，否则不建议采用

---

## 三、功能设计

### 3.1 核心功能（MVP 必备）

#### 1. 扫描目录
- 递归扫描指定目录的所有图片文件
- 支持常见图片格式：JPG、PNG、BMP、GIF、WebP
- 显示扫描进度和统计信息

#### 2. 相似度计算
- **感知哈希算法**：使用 pHash（Perceptual Hash）
- **汉明距离对比**：计算哈希之间的差异
- **可调节阈值**：用户可自定义相似度阈值（默认汉明距离 < 10）

#### 3. 分组展示
- 将相似图片自动分组
- 每组显示所有相似的图片
- 支持查看图片详细信息（分辨率、大小、拍摄时间）

#### 4. 智能推荐
- 根据多个维度自动推荐保留哪张图片：
  - 分辨率（优先保留高分辨率）
  - 文件大小（优先保留文件较大的）
  - 拍摄时间（优先保留较新的）
- 自动标记建议删除的图片

#### 5. 批量操作
- **删除**：移动到回收站
- **保留最佳**：自动保留推荐的图片，删除其他
- **手动选择**：用户手动选择保留哪些
- **撤销操作**：支持恢复误删的文件

#### 6. 安全机制
- **软删除**：删除操作实际是移动到临时回收站目录
- **定期清理**：回收站文件保留 30 天后自动清理
- **操作日志**：记录所有删除和恢复操作

### 3.2 高级功能（可选扩展）

- **重复文件检测**：基于 MD5 哈希的完全重复文件检测
- **按拍摄时间聚类**：将同一时间段拍摄的照片归类
- **地理位置聚类**：根据 EXIF 地理信息分组
- **AI 图片质量评分**：使用深度学习模型评估图片质量
- **定时任务扫描**：支持定期自动扫描新增照片

---

## 四、技术实现关键点

### 4.1 图片相似度算法

```python
# 使用感知哈希 + 汉明距离
import imagehash
from PIL import Image

def get_image_hash(image_path):
    """计算图片的感知哈希值"""
    img = Image.open(image_path)
    return imagehash.phash(img)  # 或 ahash, dhash

def compare_images(hash1, hash2):
    """计算两个哈希的汉明距离"""
    return hash1 - hash2  # 返回汉明距离，值越小越相似
    # 通常 < 10 表示相似，< 5 表示非常相似

def find_similar_images(image_hashes, threshold=10):
    """查找所有相似图片组"""
    groups = []
    processed = set()

    for img1, hash1 in image_hashes.items():
        if img1 in processed:
            continue

        group = [img1]
        for img2, hash2 in image_hashes.items():
            if img1 != img2 and img2 not in processed:
                distance = compare_images(hash1, hash2)
                if distance < threshold:
                    group.append(img2)
                    processed.add(img2)

        if len(group) > 1:
            groups.append(group)
            processed.add(img1)

    return groups
```

### 4.2 性能优化策略

#### 1. 多进程/多线程处理
```python
from concurrent.futures import ProcessPoolExecutor
import multiprocessing

def process_images_parallel(image_paths):
    """并行处理图片哈希计算"""
    cpu_count = multiprocessing.cpu_count()
    with ProcessPoolExecutor(max_workers=cpu_count) as executor:
        results = executor.map(get_image_hash, image_paths)
    return dict(zip(image_paths, results))
```

#### 2. 哈希值缓存
- 使用 SQLite 存储已计算的图片哈希值
- 记录文件修改时间，仅重新计算修改过的文件
- 大幅减少重复扫描的计算时间

#### 3. 增量扫描
- 首次扫描：全量计算所有图片哈希
- 后续扫描：只处理新增或修改的文件
- 通过文件修改时间和大小判断是否需要重新计算

#### 4. 前端分批加载
- 后端分页返回相似图片组
- 前端使用虚拟滚动（Virtual Scroll）处理大量数据
- 图片懒加载，仅加载可视区域的图片

### 4.3 NAS 路径映射

```yaml
# docker-compose.yml
version: '3.8'

services:
  photo-clean-backend:
    build: ./backend
    volumes:
      - /volume1/photo:/data/photo:ro  # 只读挂载相册目录
      - ./trash:/data/trash             # 可写挂载回收站
      - ./db:/data/db                   # 数据库存储
    environment:
      - PHOTO_DIR=/data/photo
      - TRASH_DIR=/data/trash
      - DB_PATH=/data/db/photo_clean.db

  photo-clean-frontend:
    build: ./frontend
    ports:
      - "8080:80"
    depends_on:
      - photo-clean-backend
```

**说明：**
- `/volume1/photo`：群晖照片存储路径（只读，防止误操作）
- `./trash`：回收站目录（可写）
- `./db`：数据库文件存储位置

---

## 五、开发计划

### 阶段一：核心功能开发（MVP）
**目标**：实现基础的相似图片检测和删除功能
**预计时间**：3-5 天

#### 任务 1：项目初始化
- [ ] 创建项目目录结构
- [ ] 初始化 Python 后端项目（FastAPI + requirements.txt）
- [ ] 初始化 Vue 前端项目（Vue 3 + Vite + Element Plus）
- [ ] 配置 Docker 开发环境（Dockerfile + docker-compose.yml）

#### 任务 2：后端开发
- [ ] 图片扫描模块：递归遍历目录，识别图片文件
- [ ] 哈希计算模块：使用 imagehash 计算 pHash
- [ ] 相似度对比模块：计算汉明距离，分组相似图片
- [ ] RESTful API 接口：
  - `POST /api/scan`：开始扫描目录
  - `GET /api/progress`：获取扫描进度
  - `GET /api/groups`：获取相似图片分组
  - `POST /api/delete`：删除指定图片
  - `POST /api/restore`：恢复已删除图片

#### 任务 3：前端开发
- [ ] 目录选择界面：用户选择要扫描的目录
- [ ] 扫描进度展示：实时显示扫描进度条和统计信息
- [ ] 相似图片对比查看器：
  - 并排显示相似图片
  - 显示图片元数据（分辨率、大小、时间）
  - 支持放大查看
- [ ] 批量删除操作：勾选删除、保留最佳、撤销

#### 任务 4：数据存储
- [ ] 设计 SQLite 数据库表结构：
  - `images` 表：存储图片路径、哈希、元数据
  - `operations` 表：记录删除/恢复操作日志
- [ ] 实现数据库 CRUD 操作
- [ ] 哈希值缓存逻辑

---

### 阶段二：优化与增强
**目标**：提升性能和用户体验
**预计时间**：2-3 天

#### 任务 5：性能优化
- [ ] 实现多进程图片哈希计算
- [ ] 增量扫描：仅处理新增/修改的文件
- [ ] 前端虚拟滚动：处理大量图片列表
- [ ] 图片懒加载：按需加载图片

#### 任务 6：智能推荐
- [ ] 实现图片质量评分算法：
  - 按分辨率评分
  - 按文件大小评分
  - 按拍摄时间评分
- [ ] 自动标记建议保留/删除的图片
- [ ] 提供推荐理由说明

#### 任务 7：安全机制
- [ ] 回收站功能：软删除到临时目录
- [ ] 操作日志：记录所有删除操作
- [ ] 撤销功能：恢复误删文件
- [ ] 定期清理：30 天后自动清空回收站

---

### 阶段三：部署与测试
**目标**：完成 Docker 打包和群晖部署
**预计时间**：1-2 天

#### 任务 8：Docker 打包
- [ ] 编写后端 Dockerfile（Python + FastAPI）
- [ ] 编写前端 Dockerfile（Nginx + Vue 构建产物）
- [ ] 编写 docker-compose.yml 配置文件
- [ ] 配置环境变量和卷映射

#### 任务 9：群晖部署测试
- [ ] 在群晖 Docker 中部署测试
- [ ] 测试路径映射是否正确
- [ ] 性能压力测试（10 万+ 图片）
- [ ] 功能完整性测试

#### 任务 10：文档编写
- [ ] 用户使用手册：如何安装、配置、使用
- [ ] 部署文档：群晖 Docker 部署步骤
- [ ] API 文档：接口说明（FastAPI 自动生成）
- [ ] 开发者文档：代码结构和扩展指南

---

## 六、项目目录结构

```
photo-clean/
├── backend/                      # 后端代码
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py              # FastAPI 入口文件
│   │   ├── api/                 # API 路由
│   │   │   ├── __init__.py
│   │   │   ├── scan.py          # 扫描相关接口
│   │   │   ├── images.py        # 图片操作接口
│   │   │   └── operations.py   # 删除/恢复接口
│   │   ├── core/                # 核心算法
│   │   │   ├── __init__.py
│   │   │   ├── hash.py          # 图片哈希计算
│   │   │   ├── similarity.py   # 相似度对比
│   │   │   └── scanner.py      # 目录扫描
│   │   ├── models/              # 数据模型
│   │   │   ├── __init__.py
│   │   │   ├── image.py         # 图片模型
│   │   │   └── operation.py    # 操作记录模型
│   │   ├── services/            # 业务逻辑
│   │   │   ├── __init__.py
│   │   │   ├── scan_service.py
│   │   │   └── image_service.py
│   │   └── database.py          # 数据库连接
│   ├── requirements.txt         # Python 依赖
│   ├── Dockerfile               # 后端镜像
│   └── .env.example             # 环境变量示例
│
├── frontend/                     # 前端代码
│   ├── src/
│   │   ├── components/          # Vue 组件
│   │   │   ├── ImageCard.vue    # 图片卡片组件
│   │   │   ├── ImageCompare.vue # 图片对比组件
│   │   │   └── ProgressBar.vue  # 进度条组件
│   │   ├── views/               # 页面
│   │   │   ├── Home.vue         # 首页
│   │   │   ├── ScanPage.vue     # 扫描页面
│   │   │   └── ResultPage.vue   # 结果展示页面
│   │   ├── api/                 # API 调用
│   │   │   └── index.js         # API 封装
│   │   ├── router/              # 路由配置
│   │   │   └── index.js
│   │   ├── store/               # 状态管理（Pinia）
│   │   │   └── index.js
│   │   ├── App.vue              # 根组件
│   │   └── main.js              # 入口文件
│   ├── public/                  # 静态资源
│   ├── package.json             # 前端依赖
│   ├── vite.config.js           # Vite 配置
│   ├── Dockerfile               # 前端镜像
│   └── nginx.conf               # Nginx 配置
│
├── docker-compose.yml           # Docker Compose 配置
├── .gitignore                   # Git 忽略文件
├── README.md                    # 项目说明
├── 项目规划文档.md              # 本文档
└── 部署文档.md                  # 部署指南（待创建）
```

---

## 七、时间估算

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 阶段一 | 项目初始化 | 0.5 天 |
| 阶段一 | 后端开发 | 2 天 |
| 阶段一 | 前端开发 | 1.5 天 |
| 阶段一 | 数据存储 | 0.5 天 |
| **阶段一小计** | **MVP 核心功能** | **4.5 天** |
| 阶段二 | 性能优化 | 1 天 |
| 阶段二 | 智能推荐 | 1 天 |
| 阶段二 | 安全机制 | 0.5 天 |
| **阶段二小计** | **优化与增强** | **2.5 天** |
| 阶段三 | Docker 打包 | 0.5 天 |
| 阶段三 | 群晖部署测试 | 1 天 |
| 阶段三 | 文档编写 | 0.5 天 |
| **阶段三小计** | **部署与测试** | **2 天** |
| **总计** | | **约 9 天（1-2 周）** |

---

## 八、风险与应对

### 8.1 潜在风险

#### 风险 1：性能问题
**描述**：处理大量图片（10 万+）时，计算时间过长

**影响**：用户体验差，扫描时间可能需要数小时

**应对措施**：
- 实现多进程并行计算（充分利用多核 CPU）
- 增量扫描（仅处理新增文件）
- 哈希值缓存（避免重复计算）
- 后台任务队列（异步处理，不阻塞用户操作）
- 提供扫描进度和预估时间

#### 风险 2：相似度算法误判
**描述**：感知哈希可能将不相似的图片判定为相似，或遗漏相似图片

**影响**：用户可能误删重要照片，或遗漏应该清理的图片

**应对措施**：
- 提供可调节的相似度阈值（用户自定义）
- 始终需要人工确认删除（不自动删除）
- 提供图片并排对比功能（让用户直观判断）
- 实现软删除（回收站机制，可恢复）

#### 风险 3：数据安全
**描述**：用户误删重要照片后无法恢复

**影响**：用户数据丢失，软件信任度下降

**应对措施**：
- 软删除机制：删除操作实际是移动到回收站
- 30 天保留期：回收站文件保留 30 天后才自动清理
- 操作日志：记录所有删除和恢复操作
- 撤销功能：一键恢复误删文件
- 重要提示：在删除前明确提示用户风险

### 8.2 技术限制

#### 限制 1：NAS 硬件性能
- 群晖低端型号 CPU 性能有限
- 解决：优化算法，提供低性能模式（降低并发数）

#### 限制 2：感知哈希局限性
- 无法识别裁剪、旋转后的相似图片
- 解决：未来可引入深度学习模型（需更多资源）

#### 限制 3：跨文件系统问题
- Docker 容器内外路径映射可能复杂
- 解决：详细的部署文档和配置说明

---

## 九、建议与最佳实践

### 9.1 开发建议

1. **优先实现 MVP**：快速实现核心功能，验证可行性
2. **小步迭代**：每个功能开发完立即测试，避免积累问题
3. **保持简单**：避免过度设计，功能够用即可
4. **详细日志**：添加详细日志，方便调试和问题定位
5. **单元测试**：核心算法必须有单元测试保证正确性

### 9.2 部署建议

1. **使用 Docker**：避免环境差异，一键部署
2. **配置文件外置**：重要配置通过环境变量或配置文件管理
3. **定期备份**：数据库文件定期备份
4. **监控日志**：定期查看应用日志，及时发现问题

### 9.3 用户使用建议

1. **首次扫描建议小范围测试**：选择少量图片先测试效果
2. **调整相似度阈值**：根据实际情况调整阈值（默认 10）
3. **定期清理回收站**：避免占用过多存储空间
4. **备份重要照片**：使用前务必备份重要照片

---

## 十、后续扩展方向

### 10.1 短期扩展（3-6 个月）
- 支持视频文件的相似度检测
- 移动端适配（响应式设计）
- 多语言支持（中文/英文）
- 导出报告功能（CSV/PDF）

### 10.2 中期扩展（6-12 个月）
- AI 图片质量评分（使用深度学习模型）
- 人脸识别和聚类（基于 face_recognition 库）
- 图片智能分类（场景识别）
- 支持更多 NAS 平台（威联通、极空间等）

### 10.3 长期愿景（1 年+）
- 云端版本（SaaS 服务）
- 移动 App（iOS/Android）
- 社区功能（用户分享最佳实践）
- 商业版本（高级功能付费）

---

## 十一、开始开发

### 准备工作检查清单
- [ ] 确认群晖 NAS 已安装 Docker 套件
- [ ] 确认开发机已安装 Python 3.10+
- [ ] 确认开发机已安装 Node.js 18+
- [ ] 确认开发机已安装 Docker 和 Docker Compose
- [ ] 确认有可供测试的图片样本（建议准备 100-1000 张）

### 下一步行动
当你准备好开始开发时，请回复 **"继续"**，我将按照计划依次完成：

1. ✅ 创建项目目录结构
2. ✅ 初始化后端项目（Python + FastAPI）
3. ✅ 初始化前端项目（Vue 3 + Vite）
4. ✅ 实现核心图片哈希算法
5. ✅ 实现相似度对比和分组
6. ✅ 开发后端 API 接口
7. ✅ 开发前端界面
8. ✅ 配置 Docker 打包
9. ✅ 编写部署文档
10. ✅ 进行测试和优化

---

**文档版本**：v1.0
**创建日期**：2025-12-04
**最后更新**：2025-12-04
**维护者**：开发团队
