# Photo Clean 部署文档

## 目录
- [系统要求](#系统要求)
- [快速开始](#快速开始)
- [群晖 NAS 部署](#群晖-nas-部署)
- [开发环境搭建](#开发环境搭建)
- [配置说明](#配置说明)
- [使用指南](#使用指南)
- [常见问题](#常见问题)
- [故障排除](#故障排除)

---

## 系统要求

### 硬件要求
- **CPU**: 2 核心以上（推荐 4 核心）
- **内存**: 2GB 以上（推荐 4GB）
- **存储**: 至少 2GB 可用空间（不包括照片目录）

### 软件要求
- **群晖 DSM**: 6.0 或更高版本
- **Docker**: 已安装 Docker 套件
- **浏览器**: Chrome、Firefox、Safari、Edge（最新版本）

---

## 快速开始

### 方式一：使用 Docker Compose（推荐）

1. **下载项目代码**
   ```bash
   git clone https://github.com/yourusername/photo-clean.git
   cd photo-clean
   ```

2. **配置环境变量**
   ```bash
   # 复制环境变量示例文件
   cp backend/.env.example backend/.env

   # 编辑配置文件，修改照片目录路径
   nano backend/.env
   ```

3. **修改 docker-compose.yml**

   编辑 `docker-compose.yml` 文件，修改照片目录路径：
   ```yaml
   volumes:
     # 将 /volume1/photo 修改为你的实际照片目录
     - /volume1/photo:/data/photo:ro
   ```

4. **启动服务**
   ```bash
   docker-compose up -d
   ```

5. **访问应用**

   打开浏览器访问：`http://your-nas-ip:8080`

6. **停止服务**
   ```bash
   docker-compose down
   ```

---

## 群晖 NAS 部署

### 方法一：使用群晖 Docker UI

#### 步骤 1：准备工作

1. 登录群晖 DSM
2. 打开 **套件中心**，安装 **Docker** 套件（如果尚未安装）
3. 打开 **File Station**，创建以下目录：
   - `/docker/photo-clean` - 项目目录
   - `/docker/photo-clean/data` - 数据目录

#### 步骤 2：上传项目文件

1. 将整个 `photo-clean` 项目文件夹上传到 `/docker/photo-clean`
2. 确保所有文件权限正确

#### 步骤 3：构建后端镜像

1. 打开 **Docker** 应用
2. 进入 **映像** 标签页
3. 点击 **新增** → **从文件添加**
4. 选择 `/docker/photo-clean/backend/Dockerfile`
5. 设置映像名称：`photo-clean-backend`
6. 点击 **应用** 开始构建

#### 步骤 4：构建前端镜像

重复上述步骤，构建前端镜像：
- Dockerfile 路径：`/docker/photo-clean/frontend/Dockerfile`
- 映像名称：`photo-clean-frontend`

#### 步骤 5：创建后端容器

1. 进入 **容器** 标签页
2. 点击 **新增**
3. 选择 `photo-clean-backend` 镜像
4. 配置容器：
   - **容器名称**: `photo-clean-backend`
   - **启用自动重新启动**: 勾选

5. 点击 **高级设置**：

   **卷标签页**：
   - 添加文件夹：`/volume1/photo` → `/data/photo` (只读)
   - 添加文件夹：`/docker/photo-clean/data/trash` → `/data/trash`
   - 添加文件夹：`/docker/photo-clean/data/db` → `/data/db`

   **环境标签页**，添加以下变量：
   ```
   PHOTO_DIR=/data/photo
   TRASH_DIR=/data/trash
   DB_PATH=/data/db/photo_clean.db
   SIMILARITY_THRESHOLD=10
   SCAN_WORKERS=4
   TRASH_RETENTION_DAYS=30
   ```

   **网络标签页**：
   - 选择 **bridge** 网络

6. 点击 **应用** 创建容器

#### 步骤 6：创建前端容器

1. 点击 **新增**
2. 选择 `photo-clean-frontend` 镜像
3. 配置容器：
   - **容器名称**: `photo-clean-frontend`
   - **启用自动重新启动**: 勾选

4. 点击 **高级设置**：

   **端口设置标签页**：
   - 本地端口：`8080`
   - 容器端口：`80`
   - 类型：`TCP`

   **链接标签页**：
   - 容器名称：`photo-clean-backend`
   - 别名：`backend`

5. 点击 **应用** 创建容器

#### 步骤 7：启动容器

1. 先启动 `photo-clean-backend` 容器
2. 等待后端启动完成（约 10 秒）
3. 再启动 `photo-clean-frontend` 容器

#### 步骤 8：访问应用

打开浏览器访问：`http://群晖IP:8080`

### 方法二：使用 SSH 命令行

1. **SSH 登录群晖**
   ```bash
   ssh admin@your-nas-ip
   sudo -i
   ```

2. **创建项目目录**
   ```bash
   mkdir -p /volume1/docker/photo-clean
   cd /volume1/docker/photo-clean
   ```

3. **上传或克隆项目**
   ```bash
   # 使用 git 克隆
   git clone https://github.com/yourusername/photo-clean.git .

   # 或者使用 scp 上传项目文件
   ```

4. **修改配置**
   ```bash
   # 修改 docker-compose.yml 中的照片目录路径
   nano docker-compose.yml
   ```

5. **启动服务**
   ```bash
   docker-compose up -d
   ```

6. **查看日志**
   ```bash
   docker-compose logs -f
   ```

---

## 开发环境搭建

### 后端开发

1. **安装 Python 3.10+**
   ```bash
   python3 --version
   ```

2. **创建虚拟环境**
   ```bash
   cd backend
   python3 -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   ```

3. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

4. **配置环境变量**
   ```bash
   cp .env.example .env
   # 编辑 .env 文件，配置本地路径
   ```

5. **运行开发服务器**
   ```bash
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

6. **访问 API 文档**

   打开浏览器访问：
   - Swagger UI: `http://localhost:8000/docs`
   - ReDoc: `http://localhost:8000/redoc`

### 前端开发

1. **安装 Node.js 18+**
   ```bash
   node --version
   npm --version
   ```

2. **安装依赖**
   ```bash
   cd frontend
   npm install
   ```

3. **运行开发服务器**
   ```bash
   npm run dev
   ```

4. **访问应用**

   打开浏览器访问：`http://localhost:5173`

5. **构建生产版本**
   ```bash
   npm run build
   ```

---

## 配置说明

### 环境变量

| 变量名 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `PHOTO_DIR` | 照片目录路径 | `/data/photo` | `/volume1/photo` |
| `TRASH_DIR` | 回收站目录路径 | `/data/trash` | `/data/trash` |
| `DB_PATH` | 数据库文件路径 | `/data/db/photo_clean.db` | `/data/db/photo_clean.db` |
| `SIMILARITY_THRESHOLD` | 相似度阈值（0-20） | `10` | `10` |
| `SCAN_WORKERS` | 扫描线程数 | `4` | `4` |
| `TRASH_RETENTION_DAYS` | 回收站保留天数 | `30` | `30` |

### 相似度阈值说明

相似度阈值基于汉明距离，范围 0-64：

- **0-5**: 非常相似（几乎相同）
- **6-10**: 相似（推荐值）
- **11-15**: 有一定相似性
- **16-20**: 轻微相似
- **>20**: 基本不相似

建议值：**10**（在准确性和召回率之间取得平衡）

---

## 使用指南

### 1. 首次使用

1. **访问首页**
   - 打开浏览器访问 `http://your-nas-ip:8080`
   - 查看欢迎页面和系统信息

2. **开始扫描**
   - 点击 **开始扫描** 按钮
   - 输入要扫描的目录路径（例如：`/volume1/photo`）
   - 选择是否递归扫描子目录
   - 调整相似度阈值（推荐使用默认值 10）
   - 点击 **开始扫描**

3. **查看进度**
   - 系统会实时显示扫描进度
   - 显示已扫描文件数和找到的相似组数
   - 扫描完成后会显示 **查看结果** 按钮

4. **查看结果**
   - 点击 **查看结果** 查看所有相似图片组
   - 每组显示多张相似的图片
   - 可以查看图片的详细信息（分辨率、大小等）

5. **删除图片**
   - **手动选择**: 勾选要删除的图片
   - **全选**: 点击组内的 **全选** 按钮
   - **保留最佳**: 点击 **保留最佳** 自动选中除最佳外的所有图片
   - 点击顶部的 **删除选中** 按钮

6. **确认删除**
   - 系统会弹出确认对话框
   - 图片会被移动到回收站，不会立即删除
   - 可以在 30 天内恢复

### 2. 回收站管理

1. **查看回收站**
   - 首页显示回收站文件数和大小

2. **清空回收站**
   - 点击 **清空回收站** 按钮
   - 确认后会永久删除所有回收站文件
   - **警告**: 此操作不可恢复！

3. **自动清理**
   - 回收站文件会在 30 天后自动清理
   - 可以修改环境变量 `TRASH_RETENTION_DAYS` 调整保留天数

### 3. 最佳实践

#### 首次扫描建议
1. **小范围测试**: 先选择包含少量图片的目录测试
2. **检查结果**: 确认相似度阈值设置是否合理
3. **全量扫描**: 满意后再进行全量扫描

#### 定期维护
1. **定期扫描**: 建议每月扫描一次
2. **增量扫描**: 只扫描新增照片的目录
3. **备份重要照片**: 使用前务必备份重要照片

#### 删除策略
1. **使用"保留最佳"功能**: 自动保留分辨率最高、文件最大的图片
2. **手动检查**: 对于重要照片，建议手动检查后再删除
3. **分批删除**: 不要一次删除过多图片，便于问题排查

---

## 常见问题

### Q1: 扫描速度很慢怎么办？

**A**: 可以调整以下参数优化性能：

1. **增加工作进程数**：
   修改 `SCAN_WORKERS` 环境变量（建议设置为 CPU 核心数）

2. **使用 SSD 存储**：
   如果可能，将数据库目录放在 SSD 上

3. **减少扫描范围**：
   不要一次扫描过多图片，分批处理

### Q2: 误判怎么办？

**A**:
1. **调整阈值**: 降低相似度阈值（减小数值）会更严格
2. **手动检查**: 删除前仔细检查每组图片
3. **使用回收站**: 误删的图片可以从回收站恢复

### Q3: 如何恢复已删除的图片？

**A**:
目前版本暂未提供前端恢复功能，可以通过以下方式恢复：

1. **手动恢复**：
   - 进入回收站目录：`/docker/photo-clean/data/trash`
   - 找到对应的文件
   - 手动移动回原目录

2. **使用 API 恢复**（待实现前端功能）：
   ```bash
   curl -X POST http://localhost:8000/api/images/restore \
     -H "Content-Type: application/json" \
     -d '{"file_paths": ["/path/to/image.jpg"]}'
   ```

### Q4: 数据库文件太大怎么办？

**A**:
1. **清理旧记录**: 定期清理不再需要的扫描记录
2. **重置数据库**: 删除数据库文件 `photo_clean.db`，系统会自动重建

### Q5: 如何备份数据？

**A**:
需要备份以下内容：
1. **数据库**: `/docker/photo-clean/data/db/photo_clean.db`
2. **回收站**: `/docker/photo-clean/data/trash`（如果需要）

```bash
# 备份脚本示例
tar -czf photo-clean-backup-$(date +%Y%m%d).tar.gz \
  /docker/photo-clean/data/db \
  /docker/photo-clean/data/trash
```

---

## 故障排除

### 问题 1: 容器无法启动

**症状**: Docker 容器启动后立即退出

**解决方案**:
```bash
# 查看容器日志
docker-compose logs backend
docker-compose logs frontend

# 检查常见问题：
# 1. 端口是否被占用
# 2. 目录权限是否正确
# 3. 环境变量是否配置正确
```

### 问题 2: 无法访问前端页面

**症状**: 浏览器显示无法连接

**解决方案**:
1. 检查容器是否运行：
   ```bash
   docker ps
   ```

2. 检查端口映射：
   ```bash
   docker port photo-clean-frontend
   ```

3. 检查防火墙设置：
   - 确保 8080 端口已开放

### 问题 3: 扫描失败

**症状**: 扫描任务状态显示 "failed"

**解决方案**:
1. 检查照片目录路径是否正确
2. 检查容器是否有读取权限
3. 查看后端日志：
   ```bash
   docker-compose logs -f backend
   ```

### 问题 4: 图片无法显示

**症状**: 结果页面图片无法加载

**原因**:
当前版本使用 `file://` 协议，浏览器出于安全原因可能阻止加载

**临时解决方案**:
查看图片文件路径，使用其他方式预览

**未来改进**:
将添加图片预览 API 接口

### 问题 5: 内存占用过高

**症状**: 系统内存占用过高，导致卡顿

**解决方案**:
1. 减少工作进程数：
   ```yaml
   environment:
     - SCAN_WORKERS=2  # 减少到 2
   ```

2. 分批扫描：
   - 不要一次扫描过多图片
   - 分目录逐步扫描

3. 增加系统内存（如果可能）

---

## 更新日志

### v1.0.0 (2025-12-04)
- 初始版本发布
- 实现图片扫描和相似度检测
- 实现回收站功能
- Docker 容器化部署

---

## 技术支持

如果遇到问题，请：

1. 查看本文档的常见问题和故障排除部分
2. 查看项目 [GitHub Issues](https://github.com/yourusername/photo-clean/issues)
3. 提交新的 Issue 描述问题

---

## 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。
