# 启动脚本使用说明

## 概述

为了简化 Photo Clean 项目的部署和启动流程，我们提供了两个一键启动脚本：

- `start.sh` - 适用于 Linux/macOS/Synology NAS
- `start.bat` - 适用于 Windows 系统

## 功能特性

启动脚本会自动完成以下操作：

1. **环境检查**
   - 检查 Docker 是否已安装
   - 检查 Docker Compose 是否可用
   - 验证 Docker 服务是否正常运行

2. **自动配置**
   - 创建必要的数据目录（`data/trash`, `data/db`）
   - 自动生成环境配置文件（如果不存在）
   - 检查照片目录挂载配置

3. **服务管理**
   - 清理旧的容器实例
   - 构建 Docker 镜像
   - 启动所有服务容器
   - 等待服务完全就绪

4. **状态显示**
   - 显示容器运行状态
   - 提供访问地址（本地和网络）
   - 列出常用管理命令

## 使用方法

### Linux / macOS / Synology NAS

1. **进入项目目录**
   ```bash
   cd /path/to/photo-clean
   ```

2. **运行启动脚本**
   ```bash
   ./start.sh
   ```

   如果提示权限不足，先添加执行权限：
   ```bash
   chmod +x start.sh
   ./start.sh
   ```

3. **等待启动完成**
   脚本会自动完成所有配置和启动步骤，通常需要 1-5 分钟（首次运行会更久）

### Windows

1. **进入项目目录**
   在文件资源管理器中打开项目文件夹

2. **运行启动脚本**
   双击 `start.bat` 文件，或在命令提示符中运行：
   ```cmd
   start.bat
   ```

3. **等待启动完成**
   脚本会在命令行窗口中显示进度，完成后会显示访问信息

## 首次运行注意事项

### 1. 配置照片目录

首次运行前，需要在 `docker-compose.yml` 中配置照片目录路径：

```yaml
volumes:
  # 将 /volume1/photo 修改为你的实际照片目录路径
  - /volume1/photo:/data/photo:ro
```

**示例配置：**

- Synology NAS: `/volume1/photo:/data/photo:ro`
- Linux: `/home/user/photos:/data/photo:ro`
- macOS: `/Users/username/Pictures:/data/photo:ro`
- Windows: `C:/Users/username/Pictures:/data/photo:ro`

### 2. 环境变量配置（可选）

脚本会自动从 `backend/.env.example` 创建 `.env` 文件。如需自定义配置，可编辑 `backend/.env`：

```bash
# 相似度阈值（0-20，数值越小越相似）
SIMILARITY_THRESHOLD=10

# 扫描线程数（根据 CPU 核心数调整）
SCAN_WORKERS=4

# 回收站保留天数
TRASH_RETENTION_DAYS=30
```

## 启动后的操作

启动成功后，脚本会显示类似以下信息：

```
==================================================
服务已成功启动！
==================================================

访问地址:
  本地访问: http://localhost:8080
  网络访问: http://192.168.1.100:8080

常用命令:
  查看日志: docker-compose logs -f
  停止服务: docker-compose down
  重启服务: docker-compose restart
  查看状态: docker-compose ps

数据目录:
  回收站: /path/to/photo-clean/data/trash
  数据库: /path/to/photo-clean/data/db

==================================================
```

### 访问应用

在浏览器中打开显示的访问地址即可使用应用。

### 常用管理命令

在项目目录下执行以下命令：

```bash
# 查看实时日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 停止所有服务
docker-compose down

# 重启服务
docker-compose restart

# 查看服务状态
docker-compose ps

# 进入容器内部（调试用）
docker exec -it photo-clean-backend bash
docker exec -it photo-clean-frontend sh
```

## 故障排查

### 1. Docker 未运行

**错误信息：**
```
[ERROR] Docker 未运行或权限不足，请检查 Docker 服务
```

**解决方法：**
- Linux: `sudo systemctl start docker`
- macOS: 启动 Docker Desktop 应用
- Windows: 启动 Docker Desktop 应用
- Synology: 在套件中心启动 Docker

### 2. 端口被占用

**错误信息：**
```
Error: bind: address already in use
```

**解决方法：**

检查 8080 端口是否被占用：

```bash
# Linux/macOS
lsof -i :8080

# Windows
netstat -ano | findstr :8080
```

修改 `docker-compose.yml` 中的端口映射：
```yaml
ports:
  - "8081:80"  # 将 8080 改为其他端口
```

### 3. 照片目录不存在

**警告信息：**
```
[WARNING] 照片目录不存在: /volume1/photo
```

**解决方法：**
- 确保照片目录路径正确
- 检查目录是否有读取权限
- 修改 `docker-compose.yml` 中的目录路径

### 4. 构建失败

**解决方法：**

清理并重新构建：
```bash
docker-compose down
docker system prune -af
./start.sh  # 重新运行启动脚本
```

### 5. 服务启动超时

**解决方法：**

查看详细日志排查问题：
```bash
docker-compose logs backend
docker-compose logs frontend
```

## 自定义配置

### 修改端口

编辑 `docker-compose.yml`：
```yaml
frontend:
  ports:
    - "8081:80"  # 修改为你需要的端口
```

### 修改相似度阈值

编辑 `backend/.env`：
```bash
SIMILARITY_THRESHOLD=8  # 修改为你需要的值（0-20）
```

### 修改扫描线程数

编辑 `backend/.env`：
```bash
SCAN_WORKERS=8  # 根据 CPU 核心数调整
```

## 数据管理

### 数据目录结构

```
photo-clean/
├── data/
│   ├── trash/      # 回收站目录（删除的照片）
│   └── db/         # 数据库文件
│       └── photo_clean.db
```

### 备份数据

备份数据库和回收站：
```bash
tar -czf photo-clean-backup.tar.gz data/
```

### 清理回收站

回收站中的文件会在指定天数后自动删除（默认 30 天）。也可以手动清理：
```bash
rm -rf data/trash/*
```

## 更新应用

当代码更新后，重新运行启动脚本即可：

```bash
# 1. 拉取最新代码
git pull

# 2. 运行启动脚本
./start.sh  # Linux/macOS
# 或
start.bat   # Windows
```

脚本会自动重新构建镜像并重启服务。

## 完全卸载

如果需要完全卸载应用：

```bash
# 1. 停止并删除容器
docker-compose down

# 2. 删除镜像
docker rmi photo-clean-backend photo-clean-frontend

# 3. 删除数据（可选，会删除所有扫描记录和回收站文件）
rm -rf data/

# 4. 删除项目目录
cd ..
rm -rf photo-clean/
```

## 性能优化建议

### 1. 调整扫描线程数

根据 CPU 核心数调整 `SCAN_WORKERS`：
- 4 核 CPU: 4 线程
- 8 核 CPU: 6-8 线程
- 16 核 CPU: 12-16 线程

### 2. 相似度阈值建议

- **0-5**: 几乎完全相同的照片
- **6-10**: 高度相似（推荐值）
- **11-15**: 中等相似
- **16-20**: 低相似度

### 3. 内存配置

如果照片数量很大，可以增加 Docker 内存限制：

编辑 `docker-compose.yml`：
```yaml
backend:
  deploy:
    resources:
      limits:
        memory: 4G  # 增加到 4GB
```

## 技术支持

如遇到问题，请提供以下信息：

1. 操作系统和版本
2. Docker 版本（`docker --version`）
3. 错误日志（`docker-compose logs`）
4. 配置文件内容（`docker-compose.yml`, `.env`）

提交 Issue: https://github.com/yourusername/photo-clean/issues

## 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。
